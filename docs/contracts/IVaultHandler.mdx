---
id: ivaulthandler
title: IVaultHandler
sidebar_label: IVaultHandler
slug: /contracts/ivaulthandler
---

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
  integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X"
  crossorigin="anonymous"
/>

Abstract Contract in charge of handling the collateral and the minting of the TCAP Token.

## Code

[IVaultHandler.sol](https://github.com/cryptexglobal/contracts/blob/master/contracts/IVaultHandler.sol)

## Address

TBD

## ERC165 Introspection

```sol
initialize.selector ^
setTCAPContract.selector ^
setTCAPOracle.selector ^
setCollateralContract.selector ^
setCollateralPriceOracle.selector ^
setETHPriceOracle.selector ^
setDivisor.selector ^
setRatio.selector ^
setBurnFee.selector ^
setLiquidationPenalty.selector ^
pause.selector ^
unpause.selector => 0x409e4a0f
```

The computed interface ID according to ERC-165. The interface ID is a XOR of all interface method selectors.

## Events

Events are called each time the state changes on the contract.

```sol
LogSetTCAPContract(address _owner, contract TCAP _token);
```

```sol
LogSetTCAPOracle(address _owner, contract ChainlinkOracle _oracle);
```

```sol
LogSetCollateralContract(address _owner, contract IERC20 _collateralContract);
```

```sol
LogSetCollateralPriceOracle(address _owner, contract ChainlinkOracle _priceOracle);
```

```sol
LogSetETHPriceOracle(address _owner, contract ChainlinkOracle _priceOracle);
```

```sol
LogSetDivisor(address _owner, uint256 _divisor);
```

```sol
LogSetRatio(address _owner, uint256 _ratio);
```

```sol
LogSetBurnFee(address _owner, uint256 _burnFee);
```

```sol
LogSetLiquidationPenalty(address _owner, uint256 _liquidationPenalty);
```

```sol
LogCreateVault(address _owner, uint256 _id);
```

```sol
LogAddCollateral(address _owner, uint256 _id, uint256 _amount);
```

```sol
LogRemoveCollateral(address _owner, uint256 _id, uint256 _amount);
```

```sol
LogMint(address _owner, uint256 _id, uint256 _amount);
```

```sol
LogBurn(address _owner, uint256 _id, uint256 _amount);
```

```sol
LogLiquidateVault(
  uint256 _vaultId,
  address _liquidator,
  uint256 _liquidationCollateral,
  uint256 _reward
);
```

```sol
LogRetrieveFees(address _owner, uint256 _amount);
```

## Modifiers

### vaultExists

```sol
modifier vaultExists();
```

Throws if vault hasn't been created.

### notZero

```sol
modifier notZero(uint256 _value);
```

Throws if value is 0.

## Read-Only Functions

### TCAPPrice

```sol
function TCAPPrice() public virtual view returns (uint256 price);
```

Returns the price of the TCAP token in 18 decimals. The formula for calculating the price is:

$P$ = $\frac{M}{d}$

`Where`

$P$ = TCAP Token Price

$M$ = Total Crypto Market Cap

$d$ = Divisor

`The oracle Total Crypto Market Cap must is in wei format.`

### requiredCollateral

```sol
function requiredCollateral(uint256 _amount) public virtual view
  returns (uint256 collateral);
```

Returns the minimal required collateral to mint TCAP token. The formula for calculating the required collateral is:

$C$ = $\frac{(P * A * r) / 100}{cp}$

`Where`

$C$ = Required Collateral

$P$ = TCAP Token Price

$A$ = Amount to Mint

$cp$ = Collateral Price

`It's divided by 100 as eth price comes in wei to cancel the additional 0s`

### requiredLiquidationCollateral

```sol
function requiredLiquidationCollateral(uint256 _vaultId)
  public
  virtual
  view
  returns (uint256 collateral);
```

Returns the minimal required TCAP to liquidate a Vault. The formula for calculating the required collateral is:

$LC$ = $\frac{(((D * r) / 100) - cTcap) * 100}{ (r - (p + 100))}$

$cTcap$ = $\frac{C/cp}{P}$

`Where`

$LC$ = Required Liquidation Collateral

$D$ = Vault Debt

$C$ = Required Collateral

$P$ = TCAP Token Price

$cp$ = Collateral Price

$r$ = Min Vault Ratio

$p$ = Liquidation Penalty

### liquidationReward

```sol
function liquidationReward(uint256 _vaultId)
  public
  virtual
  view
  returns (uint256 rewardCollateral);
```

Returns the reward for liquidating a vault, the reward is taken from the liquidated vault. The formula for calculating the reward is:

$R$ = $\frac{(LC * (p + 100))} {100}$

`Where`

$R$ = Liquidation Reward

$LC$ = Required Liquidation Collateral

$p$ = liquidation penalty

### getVault

```sol
function getVault(uint256 _id)
  public
  virtual
  view
  returns (uint256, uint256, address, uint256);
```

Returns the Vault information.

### getVaultRatio

```sol
function getVaultRatio(uint256 _vaultId)
  public
  virtual
  view
  returns (uint256 currentRatio);
```

Returns the Collateral Ratio fo the Vault. The formula for calculating the ratio is:

$vr$ = $\frac{cp * C * 100}{D - P}$

`Where`

$vr$ = Vault Ratio

$C$ = Vault Collateral

$cp$ = Collateral Price

$D$ = Vault Debt

$P$ = TCAP Token Price

### getFee

```sol
 function getFee(uint256 _amount) public virtual view returns (uint256 fee);
```

Returns the required fee to burn the TCAP tokens, the returned value is returned on ETH. The formula for calculating the burning fee is:

$f$ = $\frac{((P * A * b)}{100}$

$f$ = Burn Fee Value

$P$ = TCAP Token Price

$A$ = Amount to Burn

$b$ = Burn Fee %

### \_checkBurnFee

```sol
function _checkBurnFee(uint256 _amount) internal;
```

Returns the required fee to burn the TCAP tokens

### supportsInterface

```sol
function supportsInterface(bytes4 interfaceId)
  external
  override
  view
  returns (bool);
```

ERC165 Standard for support of interfaces

## State-Changing Functions

### constructor

```sol
constructor(Orchestrator _orchestrator) public;
```

Called once the contract it's deployed, sets the orchestrator as owner. It also sets the vault counter to 1 as 0 is reserved for empty objects.

### initialize

```sol
function initialize(
  uint256 _divisor,
  uint256 _ratio,
  uint256 _burnFee,
  uint256 _liquidationPenalty,
  address _tcapOracle,
  TCAP _tcapAddress,
  address _collateralAddress,
  address _collateralOracle,
  address _ethOracle
) public virtual onlyOwner;
```

Allows the orchestrator to initialize the contract. Only owner can call it. Can only be called once.

### setTCAPContract

```sol
function setTCAPContract(TCAP _TCAPToken) public virtual onlyOwner;
```

Sets the address of the TCAP ERC20 contract. Only owner can call it.

### setTCAPOracle

```sol
function setTCAPOracle(ChainlinkOracle _oracle) public virtual onlyOwnerl;
```

Sets the address of the oracle contract for the price feed. Only owner can call it.

### setCollateralContract

```sol
function setCollateralContract(IERC20 _collateralContract)
  public
  virtual
  onlyOwner;
```

Sets the address of the collateral contract. Only owner can call it.

### setCollateralPriceOracle

```sol
function setCollateralPriceOracle(ChainlinkOracle _collateral)
  public
  onlyOwner;
```

Sets the address of the oracle contract for the price feed. Only owner can call it.

### setETHPriceOracle

```sol
setETHPriceOracle(ChainlinkOracle _ethPriceOracle) public onlyOwner;
```

Sets the address of the oracle contract for the ETH price feed. Only owner can call it.

### setDivisor

```sol
setDivisor(uint256 _divisor) public virtual onlyOwner;
```

Sets the divisor amount for token price calculation. Only owner can call it.

### setRatio

```sol
function setRatio(uint256 _ratio) public virtual onlyOwner;
```

Sets the collateral ratio needed to mint tokens. Only owner can call it.

### setBurnFee

```sol
function setBurnFee(uint256 _burnFee) public virtual onlyOwner;
```

Sets the collateral ratio needed to mint tokens. Only owner can call it.

### setLiquidationPenalty

```sol
function setLiquidationPenalty(uint256 _liquidationPenalty)
  public
  virtual
  onlyOwner;
```

Sets the liquidation penalty % charged on liquidation. Only owner can call it.

### createVault

```sol
function createVault() public virtual whenNotPaused;
```

Allows sender to creates a Vault with an unique ID. Only one vault per address can be created.

### addCollateral

```sol
function addCollateral(uint256 _amount)
  public
  virtual
  nonReentrant
  vaultExists
  whenNotPaused
  notZero(_amount);
```

Adds collateral to vault,`_amount` should be higher than 0.

### removeCollateral

```sol
function removeCollateral(uint256 _amount)
  public
  virtual
  nonReentrant
  vaultExists
  whenNotPaused
  notZero(_amount);
```

Removes not used collateral from collateral, `_amount` should be higher than 0.

### mint

```sol
function mint(uint256 _amount)
  public
  virtual
  nonReentrant
  vaultExists
  whenNotPaused
  notZero(_amount)
```

Mints TCAP Tokens staking the collateral,`_amount` should be higher than 0.

### \_burn

```sol
function _burn(uint256 _vaultId, uint256 _amount) internal;
```

Internal function that burns the `_amount` of TCAP Tokens, called by the [burn](#burn) and [liquidateVault](#liquidateVault) functions.

### burn

```sol
function burn(uint256 _amount)
  public
  virtual
  payable
  nonReentrant
  vaultExists
  whenNotPaused
  notZero(_amount);
```

Burns TCAP Tokens releasing the staked collateral,`_amount` should be higher than 0. A fee on ETH must be paid when executing a TCAP burn, the fee is a % defined by the contract `burnFee` of the `_amount` of TCAP tokens to burn.

### liquidateVault

```sol
function liquidateVault(uint256 _vaultId, uint256 requiredCollateral)
  public
  payable
  nonReentrant
  whenNotPaused;
```

Allow users to liquidate vaults that have less ratio than the one defined on the contract`ratio`. The same burn fee has to be paid as the burn function is called. The vault owner also pays a % defined by `liquidationPenalty` to discourage users to get liquidated.

### pause

```sol
function pause() public onlyOwner;
```

Allows owner to Pause the Contract.

### unpause

```sol
  function unpause() public onlyOwner;
```

Allows owner to Unpause the Contract.

### retrieveFees

```sol
function retrieveFees() public virtual onlyOwner;
```

Sends the owner of the contract the ETH generated by burning TCAP.
