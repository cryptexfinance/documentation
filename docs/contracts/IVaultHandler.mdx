---
id: ivaulthandler
title: IVaultHandler
sidebar_label: IVaultHandler
slug: /ivaulthandler
---

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
  integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X"
  crossorigin="anonymous"
/>

Abstract Contract in charge of handling the collateral and the minting of the TCAP Token.

## Code

[IVaultHandler.sol](https://github.com/cryptexglobal/contracts/blob/master/contracts/IVaultHandler.sol)

## Address

TBD

## Events

Events are called each time the state changes on the contract.

```sol
LogSetTCAPContract(address _owner, contract TCAP _token);
```

```sol
LogSetTCAPOracle(address _owner, contract ChainlinkOracle _oracle);
```

```sol
LogSetCollateralContract(address _owner, contract IERC20 _collateralContract);
```

```sol
LogSetCollateralPriceOracle(address _owner, contract ChainlinkOracle _priceOracle);
```

```sol
LogSetETHPriceOracle(address _owner, contract ChainlinkOracle _priceOracle);
```

```sol
LogSetDivisor(address _owner, uint256 _divisor);
```

```sol
LogSetRatio(address _owner, uint256 _ratio);
```

```sol
LogSetBurnFee(address _owner, uint256 _burnFee);
```

```sol
LogSetLiquidationPenalty(address _owner, uint256 _liquidationPenalty);
```

```sol
LogCreateVault(address _owner, uint256 _id);
```

```sol
LogAddCollateral(address _owner, uint256 _id, uint256 _amount);
```

```sol
LogRemoveCollateral(address _owner, uint256 _id, uint256 _amount);
```

```sol
LogMint(address _owner, uint256 _id, uint256 _amount);
```

```sol
LogBurn(address _owner, uint256 _id, uint256 _amount);
```

```sol
LogLiquidateVault(uint256 _vaultId, address _liquidator, uint256 _liquidationCollateral, uint256 _reward);
```

```sol
LogRetrieveFees(address _owner, uint256 _amount);
```

## Modifiers

### vaultExists

```sol
modifier vaultExists();
```

Throws if vault hasn't been created.

### notZero

```sol
modifier notZero(uint256 _value);
```

Throws if value is 0.

## Read-Only Functions

### TCAPPrice

```sol
function TCAPPrice() public virtual view returns (uint256 price);
```

Returns the price of the TCAP token in 18 decimals. The formula for calculating the price is:

$P$ = $\frac{M}{d}$

`Where`

$P$ = TCAP Token Price

$M$ = Total Crypto Market Cap

$d$ = Divisor

`The oracle Total Crypto Market Cap must is in wei format.`

### requiredCollateral

```sol
function requiredCollateral(uint256 _amount) public virtual view returns (uint256 collateral);
```

Returns the minimal required collateral to mint TCAP token. The formula for calculating the price is:

$C$ = $\frac{(P * A * r) / 100}{cp}$

`Where`

$C$ = Required Collateral

$P$ = TCAP Token Price

$A$ = Amount to Mint

$cp$ = Collateral Price

`It's divided by 100 as eth price comes in wei to cancel the additional 0s`

### `requiredLiquidationCollateral(uint256 _vaultId) → uint256 collateral` (public)

Returns the minimal required TCAP to liquidate a Vault

LC = ((((D _ r) / 100) - cTcap) _ 100) / (r - (p + 100))
cTcap = ((C \* cp) / P)
LC = Required Liquidation Collateral
D = Vault Debt
C = Required Collateral
P = TCAP Token Price
cp = Collateral Price
r = Min Vault Ratio
p = Liquidation Penalty

### `liquidationReward(uint256 _vaultId) → uint256 rewardCollateral` (public)

Returns the minimal required TCAP to liquidate a Vault

the returned value is returned on the vault collateral
R = (LC \* (p + 100)) / 100
R = Liquidation Reward
LC = Required Liquidation Collateral
p = liquidation penalty

### `getVault(uint256 _id) → uint256, uint256, address, uint256` (public)

Returns the Vault information

### `getVaultRatio(uint256 _vaultId) → uint256 currentRatio` (public)

Returns the Collateral Ratio fo the Vault

vr = (cp _ (C _ 100)) / D - P
vr = Vault Ratio
C = Vault Collateral
cp = Collateral Price
D = Vault Debt
P = TCAP Token Price

### `getFee(uint256 _amount) → uint256 fee` (public)

Returns the required fee to burn the TCAP tokens

The returned value is returned on ETH
f = ((P _ A _ b)/ 100)
f = Burn Fee Value
P = TCAP Token Price
A = Amount to Burn
b = Burn Fee %

### `_checkBurnFee(uint256 _amount)` (internal)

Returns the required fee to burn the TCAP tokens

### `_burn(uint256 _vaultId, uint256 _amount)` (internal)

Burns an amount of TCAP Tokens

### `supportsInterface(bytes4 interfaceId) → bool` (external)

ERC165 Standard for support of interfaces

## State-Changing Functions

### `constructor(contract Orchestrator _orchestrator)` (public)

counter starts in one as 0 is reserved for empty objects

### `initialize(uint256 _divisor, uint256 _ratio, uint256 _burnFee, uint256 _liquidationPenalty, address _tcapOracle, contract TCAP _tcapAddress, address _collateralAddress, address _collateralOracle, address _ethOracle)` (public)

Allows the orchestrator to initialize the contract

Only owner can call it
Can only be called once

### `setTCAPContract(contract TCAP _TCAPToken)` (public)

Sets the address of the TCAP ERC20 contract

Only owner can call it

### `setTCAPOracle(contract ChainlinkOracle _oracle)` (public)

Sets the address of the oracle contract for the price feed

Only owner can call it

### `setCollateralContract(contract IERC20 _collateralContract)` (public)

Sets the address of the collateral contract

Only owner can call it

### `setCollateralPriceOracle(contract ChainlinkOracle _collateral)` (public)

Sets the address of the oracle contract for the price feed

Only owner can call it

### `setETHPriceOracle(contract ChainlinkOracle _ethPriceOracle)` (public)

Sets the address of the oracle contract for the ETH price feed

Only owner can call it

### `setDivisor(uint256 _divisor)` (public)

Sets the divisor amount for token price calculation

Only owner can call it

### `setRatio(uint256 _ratio)` (public)

Sets the collateral ratio needed to mint tokens

Only owner can call it

### `setBurnFee(uint256 _burnFee)` (public)

Sets the collateral ratio needed to mint tokens

Only owner can call it

### `setLiquidationPenalty(uint256 _liquidationPenalty)` (public)

Sets the liquidation penalty % charged on liquidation

Only owner can call it

### `createVault()` (public)

Creates a Vault

### `addCollateral(uint256 _amount)` (public)

Adds collateral to vault

\_amount should be higher than 0

### `removeCollateral(uint256 _amount)` (public)

Removes not used collateral from collateral

\_amount should be higher than 0

### `mint(uint256 _amount)` (public)

Mints TCAP Tokens staking the collateral

\_amount should be higher than 0

### `burn(uint256 _amount)` (public)

Burns TCAP Tokens releasing the staked collateral

\_amount should be higher than 0

### `liquidateVault(uint256 _vaultId, uint256 requiredCollateral)` (public)

Allow users to liquidate vaults with low collateral ratio

### `pause()` (public)

Allows owner to Pause the Contract

### `unpause()` (public)

Allows owner to Unpause the Contract

### `retrieveFees()` (public)

Sends the owner of the contract the Fees saved on ETH
